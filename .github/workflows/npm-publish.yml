name: Publish npm packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        default: false
        type: boolean

env:
  DEBUG: napi:*
  MACOSX_DEPLOYMENT_TARGET: "10.13"

jobs:
  build:
    name: Build - ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
            npm_pkg: darwin-x64
            build: |
              cd crates/uira-napi
              bun run build --target x86_64-apple-darwin
              strip -x *.node
          - host: macos-latest
            target: aarch64-apple-darwin
            npm_pkg: darwin-arm64
            build: |
              cd crates/uira-napi
              bun run build --target aarch64-apple-darwin
              strip -x *.node
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            npm_pkg: linux-x64-gnu
            build: |
              cd crates/uira-napi
              bun run build --target x86_64-unknown-linux-gnu --use-napi-cross
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            npm_pkg: linux-x64-musl
            build: |
              cd crates/uira-napi
              bun run build --target x86_64-unknown-linux-musl -x
          - host: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            npm_pkg: linux-arm64-gnu
            build: |
              cd crates/uira-napi
              bun run build --target aarch64-unknown-linux-gnu --use-napi-cross
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            npm_pkg: win32-x64-msvc
            build: |
              cd crates/uira-napi
              bun run build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.napi-rs
            target/
          key: ${{ matrix.settings.target }}-cargo-${{ hashFiles('Cargo.lock') }}

      - uses: mlugg/setup-zig@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        with:
          version: 0.13.0

      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild

      - name: Install dependencies
        run: bun install
        working-directory: crates/uira-napi

      - name: Build native
        run: ${{ matrix.settings.build }}
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.settings.target }}
          path: crates/uira-napi/*.node
          if-no-files-found: error

      - name: Upload generated NAPI files
        if: matrix.settings.target == 'x86_64-unknown-linux-gnu'
        uses: actions/upload-artifact@v4
        with:
          name: napi-generated
          path: |
            crates/uira-napi/index.js
            crates/uira-napi/index.d.ts
          if-no-files-found: error

  publish:
    name: Publish packages
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -la artifacts/

      - name: Move native bindings to package
        run: |
          mkdir -p packages/uira/npm
          
          # Copy each platform's binary
          for dir in artifacts/bindings-*; do
            target=$(basename "$dir" | sed 's/bindings-//')
            case "$target" in
              x86_64-apple-darwin)
                mkdir -p packages/uira/npm/darwin-x64
                cp "$dir"/*.node packages/uira/npm/darwin-x64/
                ;;
              aarch64-apple-darwin)
                mkdir -p packages/uira/npm/darwin-arm64
                cp "$dir"/*.node packages/uira/npm/darwin-arm64/
                ;;
              x86_64-unknown-linux-gnu)
                mkdir -p packages/uira/npm/linux-x64-gnu
                cp "$dir"/*.node packages/uira/npm/linux-x64-gnu/
                ;;
              x86_64-unknown-linux-musl)
                mkdir -p packages/uira/npm/linux-x64-musl
                cp "$dir"/*.node packages/uira/npm/linux-x64-musl/
                ;;
              aarch64-unknown-linux-gnu)
                mkdir -p packages/uira/npm/linux-arm64-gnu
                cp "$dir"/*.node packages/uira/npm/linux-arm64-gnu/
                ;;
              x86_64-pc-windows-msvc)
                mkdir -p packages/uira/npm/win32-x64-msvc
                cp "$dir"/*.node packages/uira/npm/win32-x64-msvc/
                ;;
            esac
          done
          
          # Copy generated NAPI files
          cp artifacts/napi-generated/index.js packages/uira/
          cp artifacts/napi-generated/index.d.ts packages/uira/

      - name: Update versions
        run: |
          VERSION="${{ inputs.version }}"
          
          # Update main package
          cd packages/uira
          npm version "$VERSION" --no-git-tag-version
          
          # Update hook package
          cd ../hook
          npm version "$VERSION" --no-git-tag-version
          
          # Update dependency version in hook package
          npm pkg set "dependencies.@uiradev/uira=^$VERSION"

      - name: Create platform packages
        run: |
          VERSION="${{ inputs.version }}"
          
          platforms=(
            "darwin-x64:macos x64"
            "darwin-arm64:macos arm64 (Apple Silicon)"
            "linux-x64-gnu:linux x64 (glibc)"
            "linux-x64-musl:linux x64 (musl/Alpine)"
            "linux-arm64-gnu:linux arm64 (glibc)"
            "win32-x64-msvc:windows x64"
          )
          
          for platform_info in "${platforms[@]}"; do
            platform="${platform_info%%:*}"
            description="${platform_info#*:}"
            
            pkg_dir="packages/uira/npm/$platform"
            if [ -d "$pkg_dir" ]; then
              cat > "$pkg_dir/package.json" << EOF
          {
            "name": "@uiradev/uira-$platform",
            "version": "$VERSION",
            "description": "Native binding for uira on $description",
            "os": ["$(echo $platform | cut -d'-' -f1 | sed 's/darwin/darwin/;s/linux/linux/;s/win32/win32/')"],
            "cpu": ["$(echo $platform | cut -d'-' -f2)"],
            "main": "uira.node",
            "files": ["uira.node"],
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/junhoyeo/uira"
            }
          }
          EOF
              
              # Rename the .node file
              if [ -f "$pkg_dir"/*.node ]; then
                mv "$pkg_dir"/*.node "$pkg_dir/uira.node"
              fi
            fi
          done

      - name: Install dependencies and build TypeScript
        run: |
          cd packages/uira
          bun install
          bun run build:ts
          
          cd ../hook
          bun install
          bun run build

      - name: Publish platform packages
        if: ${{ !inputs.dry_run }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          failed_packages=""
          for pkg_dir in packages/uira/npm/*/; do
            if [ -f "$pkg_dir/package.json" ]; then
              pkg_name=$(basename "$pkg_dir")
              echo "Publishing $pkg_name..."
              cd "$pkg_dir"
              if ! npm publish --access public 2>&1; then
                echo "::warning::Failed to publish $pkg_name"
                failed_packages="$failed_packages $pkg_name"
              fi
              cd -
            fi
          done
          if [ -n "$failed_packages" ]; then
            echo "::error::Failed to publish:$failed_packages"
            exit 1
          fi

      - name: Publish main package
        if: ${{ !inputs.dry_run }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd packages/uira
          npm publish --access public

      - name: Publish hook package
        if: ${{ !inputs.dry_run }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd packages/hook
          npm publish --access public

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "DRY RUN - Would have published:"
          echo "- @uiradev/uira@${{ inputs.version }}"
          echo "- @uiradev/hook@${{ inputs.version }}"
          for pkg_dir in packages/uira/npm/*/; do
            if [ -f "$pkg_dir/package.json" ]; then
              echo "- @uiradev/uira-$(basename $pkg_dir)@${{ inputs.version }}"
            fi
          done

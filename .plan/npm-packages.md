# npm Packages Distribution Plan

> **Reviewed by Oracle** - Updated with best practices from SWC/Rspack/Oxc ecosystem

## Overview

Distribute uira as npm packages using napi-rs bindings. Two packages with modular subpath exports.

**Key Design Decisions:**
- Ship real Rust binary for CLI (Sentry pattern) - not napi `run_cli()`
- napi bindings for library API only
- `@uiradev/hook` uses `dependencies` (not `peerDependencies`)
- Support Linux ARM64 as first-class target

## Package Structure

```
npm packages:
├── @uiradev/uira              # Main package (CLI binary + library API)
│   ├── bin/uira               # Executes platform-specific Rust binary
│   ├── ./                     # Full API (napi bindings)
│   ├── ./comments             # Comment checker module
│   ├── ./hooks                # Git hooks module
│   ├── ./oxc                  # Linter module
│   └── ./agent                # AI agent module
│
├── @uiradev/hook              # Lightweight hooks-only package
│   └── dependencies: @uiradev/uira (re-exports hooks + CLI)
│
└── Platform packages (optionalDependencies):
    ├── @uiradev/uira-darwin-arm64
    ├── @uiradev/uira-darwin-x64
    ├── @uiradev/uira-linux-x64-gnu
    ├── @uiradev/uira-linux-x64-musl
    ├── @uiradev/uira-linux-arm64-gnu    # First-class ARM64 support
    └── @uiradev/uira-win32-x64-msvc
```

## Phase 1: Package Scaffolding

### 1.1 Create npm workspace structure

```
packages/
├── uira/                      # @uiradev/uira
│   ├── package.json
│   ├── npm/                   # Platform-specific packages (generated by napi)
│   │   ├── darwin-arm64/
│   │   │   ├── package.json
│   │   │   └── uira           # Rust binary
│   │   ├── darwin-x64/
│   │   ├── linux-x64-gnu/
│   │   ├── linux-x64-musl/
│   │   ├── linux-arm64-gnu/   # ARM64 Linux
│   │   └── win32-x64-msvc/
│   ├── bin/
│   │   └── uira.js            # Executes platform binary
│   ├── src/
│   │   ├── index.ts           # Main exports
│   │   ├── comments.ts        # Comment checker exports
│   │   ├── hooks.ts           # Hooks exports
│   │   ├── oxc.ts             # Linter exports
│   │   └── agent.ts           # Agent exports
│   └── scripts/
│       └── postinstall.js
│
└── hook/                      # @uiradev/hook
    ├── package.json
    ├── bin/
    │   └── uira-hook.js
    └── src/
        └── index.ts
```

### 1.2 @uiradev/uira package.json

```json
{
  "name": "@uiradev/uira",
  "version": "0.1.0",
  "description": "Lightning-fast AI coding agent & git hooks manager built in Rust",
  "main": "./dist/index.js",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.ts",
  "bin": {
    "uira": "./bin/uira.js"
  },
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./comments": {
      "import": "./dist/comments.mjs",
      "require": "./dist/comments.js",
      "types": "./dist/comments.d.ts"
    },
    "./hooks": {
      "import": "./dist/hooks.mjs",
      "require": "./dist/hooks.js",
      "types": "./dist/hooks.d.ts"
    },
    "./oxc": {
      "import": "./dist/oxc.mjs",
      "require": "./dist/oxc.js",
      "types": "./dist/oxc.d.ts"
    },
    "./agent": {
      "import": "./dist/agent.mjs",
      "require": "./dist/agent.js",
      "types": "./dist/agent.d.ts"
    },
    "./package.json": "./package.json"
  },
  "napi": {
    "name": "uira",
    "triples": {
      "defaults": true,
      "additional": [
        "aarch64-apple-darwin",
        "x86_64-apple-darwin",
        "x86_64-unknown-linux-gnu",
        "x86_64-unknown-linux-musl",
        "aarch64-unknown-linux-gnu",
        "x86_64-pc-windows-msvc"
      ]
    }
  },
  "scripts": {
    "build": "napi build --platform --release",
    "build:ts": "tsup src/index.ts src/comments.ts src/hooks.ts src/oxc.ts src/agent.ts --format cjs,esm --dts",
    "prepublishOnly": "napi prepublish -t npm"
  },
  "optionalDependencies": {
    "@uiradev/uira-darwin-arm64": "0.1.0",
    "@uiradev/uira-darwin-x64": "0.1.0",
    "@uiradev/uira-linux-x64-gnu": "0.1.0",
    "@uiradev/uira-linux-x64-musl": "0.1.0",
    "@uiradev/uira-linux-arm64-gnu": "0.1.0",
    "@uiradev/uira-win32-x64-msvc": "0.1.0"
  },
  "devDependencies": {
    "tsup": "^8.0.0",
    "typescript": "^5.0.0"
  }
}
```

### 1.3 @uiradev/hook package.json

```json
{
  "name": "@uiradev/hook",
  "version": "0.1.0",
  "description": "Git hooks made easy with AI assistance",
  "bin": {
    "uira-hook": "./bin/uira-hook.js"
  },
  "main": "./dist/index.js",
  "dependencies": {
    "@uiradev/uira": "^0.1.0"
  },
  "scripts": {
    "postinstall": "node scripts/install.js"
  }
}
```

> **Note**: Uses `dependencies` not `peerDependencies` to ensure @uiradev/uira is always installed when the CLI runs.

## Phase 2: napi-rs Bindings (Library API Only)

> **Important**: napi bindings are for library API only. CLI uses real Rust binary.

### 2.1 Refactor crates/uira-napi

```rust
// crates/uira-napi/src/lib.rs

use napi_derive::napi;

pub mod comments;
pub mod hooks;
pub mod oxc;
pub mod agent;

// NO cli module - CLI is a separate binary
```

### 2.2 Comments module

```rust
// crates/uira-napi/src/comments.rs

use napi::bindgen_prelude::*;
use napi_derive::napi;
use uira_comment_checker::{CommentDetector, FilterChain};

#[napi(object)]
pub struct Comment {
    pub text: String,
    pub line_number: u32,
    pub column: u32,
    pub file: String,
    pub comment_type: String,
}

#[napi]
pub struct CommentChecker {
    detector: CommentDetector,
    filter: FilterChain,
}

#[napi]
impl CommentChecker {
    #[napi(constructor)]
    pub fn new() -> Self {
        Self {
            detector: CommentDetector::new(),
            filter: FilterChain::new(),
        }
    }

    #[napi]
    pub fn detect(&self, code: String, filename: String, include_docstrings: bool) -> Vec<Comment> {
        self.detector
            .detect(&code, &filename, include_docstrings)
            .into_iter()
            .filter(|c| !self.filter.should_skip(c))
            .map(|c| Comment {
                text: c.text,
                line_number: c.line_number as u32,
                column: c.column as u32,
                file: c.file,
                comment_type: format!("{:?}", c.comment_type),
            })
            .collect()
    }
}
```

### 2.3 Hooks module

```rust
// crates/uira-napi/src/hooks.rs

use napi::bindgen_prelude::*;
use napi_derive::napi;

#[napi(object)]
pub struct HookConfig {
    pub pre_commit: Option<bool>,
    pub pre_push: Option<bool>,
    pub commit_msg: Option<bool>,
}

#[napi]
pub fn install_hooks(config: HookConfig) -> Result<()> {
    // Synchronous implementation - no async needed for file operations
    // Uses uira hooks logic
    todo!()
}

#[napi]
pub fn run_hook(hook_name: String) -> Result<bool> {
    // Synchronous implementation
    todo!()
}
```

### 2.4 OXC module

```rust
// crates/uira-napi/src/oxc.rs

use napi::bindgen_prelude::*;
use napi_derive::napi;
use uira_oxc::{Linter as RustLinter, LintRule};

#[napi(object)]
pub struct Diagnostic {
    pub file: String,
    pub line: u32,
    pub column: u32,
    pub message: String,
    pub rule: String,
    pub severity: String,
    pub suggestion: Option<String>,
}

#[napi]
pub struct Linter {
    inner: RustLinter,
}

#[napi]
impl Linter {
    #[napi(constructor)]
    pub fn new() -> Self {
        Self {
            inner: RustLinter::new(LintRule::recommended()),
        }
    }

    #[napi]
    pub fn lint_files(&self, files: Vec<String>) -> Vec<Diagnostic> {
        self.inner
            .lint_files(&files)
            .into_iter()
            .map(|d| Diagnostic {
                file: d.file,
                line: d.line as u32,
                column: d.column as u32,
                message: d.message,
                rule: d.rule,
                severity: format!("{:?}", d.severity),
                suggestion: d.suggestion,
            })
            .collect()
    }
}
```

### 2.5 Agent module

```rust
// crates/uira-napi/src/agent.rs

use napi::bindgen_prelude::*;
use napi_derive::napi;
use std::sync::Arc;
use tokio::sync::Mutex;

#[napi(object)]
pub struct AgentConfig {
    pub model: Option<String>,
    pub provider: Option<String>,
    pub api_key: Option<String>,
    pub working_directory: Option<String>,
}

#[napi(object)]
pub struct AgentResult {
    pub success: bool,
    pub output: String,
    pub turns: u32,
    pub error: Option<String>,
}

// Wrap mutable state in Arc<Mutex<_>> for async safety
#[napi]
pub struct Agent {
    inner: Arc<Mutex<AgentInner>>,
}

struct AgentInner {
    // Internal agent state
}

#[napi]
impl Agent {
    #[napi(constructor)]
    pub fn new(config: AgentConfig) -> Result<Self> {
        todo!()
    }

    #[napi]
    pub async fn run(&self, prompt: String) -> Result<AgentResult> {
        let guard = self.inner.lock().await;
        // Use guard to run agent
        todo!()
    }
}
```

## Phase 3: TypeScript Wrapper

### 3.1 Main index.ts

```typescript
// packages/uira/src/index.ts

export { CommentChecker, type Comment } from './comments';
export { installHooks, runHook, type HookConfig } from './hooks';
export { Linter, type Diagnostic } from './oxc';
export { Agent, type AgentConfig, type AgentResult } from './agent';
```

### 3.2 Comments wrapper

```typescript
// packages/uira/src/comments.ts

import { CommentChecker as NativeCommentChecker } from './native';

export interface Comment {
  text: string;
  lineNumber: number;
  column: number;
  file: string;
  commentType: 'line' | 'block' | 'doc';
}

export class CommentChecker {
  private native: NativeCommentChecker;

  constructor() {
    this.native = new NativeCommentChecker();
  }

  detect(code: string, filename: string, includeDocstrings = false): Comment[] {
    return this.native.detect(code, filename, includeDocstrings);
  }
}
```

## Phase 4: CLI Binary Distribution (Sentry Pattern)

> **Why binary instead of napi run_cli()?**
> - No signal handling issues (Ctrl+C, SIGINT)
> - No async runtime conflicts between Node and Tokio
> - Exact parity with `cargo install uira`
> - Better TTY behavior

### 4.1 bin/uira.js (executes platform binary)

```javascript
#!/usr/bin/env node

const { execFileSync } = require('child_process');
const path = require('path');
const fs = require('fs');

// Platform detection
const PLATFORMS = {
  'darwin-arm64': '@uiradev/uira-darwin-arm64',
  'darwin-x64': '@uiradev/uira-darwin-x64',
  'linux-x64': '@uiradev/uira-linux-x64-gnu',
  'linux-arm64': '@uiradev/uira-linux-arm64-gnu',
  'win32-x64': '@uiradev/uira-win32-x64-msvc',
};

function getBinaryPath() {
  const platform = process.platform;
  const arch = process.arch;
  const key = `${platform}-${arch}`;
  
  const packageName = PLATFORMS[key];
  if (!packageName) {
    console.error(`Unsupported platform: ${key}`);
    console.error('Supported platforms:', Object.keys(PLATFORMS).join(', '));
    process.exit(1);
  }

  try {
    const packagePath = require.resolve(`${packageName}/package.json`);
    const packageDir = path.dirname(packagePath);
    const binaryName = platform === 'win32' ? 'uira.exe' : 'uira';
    return path.join(packageDir, binaryName);
  } catch (e) {
    console.error(`Failed to find binary package: ${packageName}`);
    console.error('Try reinstalling: npm install @uiradev/uira');
    process.exit(1);
  }
}

const binary = getBinaryPath();
const args = process.argv.slice(2);

try {
  execFileSync(binary, args, { stdio: 'inherit' });
} catch (e) {
  if (e.status !== undefined) {
    process.exit(e.status);
  }
  throw e;
}
```

### 4.2 bin/uira-hook.js (for @uiradev/hook)

```javascript
#!/usr/bin/env node

const { installHooks, runHook } = require('@uiradev/uira/hooks');

const args = process.argv.slice(2);
const command = args[0];

async function main() {
  switch (command) {
    case 'install':
      installHooks({ preCommit: true, prePush: true });
      console.log('✓ Git hooks installed');
      break;
    case 'run':
      const hookName = args[1];
      if (!hookName) {
        console.error('Usage: uira-hook run <hook-name>');
        process.exit(1);
      }
      const success = runHook(hookName);
      process.exit(success ? 0 : 1);
      break;
    default:
      console.log('Usage: uira-hook <install|run> [hook-name]');
      console.log('');
      console.log('Commands:');
      console.log('  install     Install git hooks');
      console.log('  run <hook>  Run a specific hook');
  }
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
```

## Phase 5: Build & Publish

### 5.1 GitHub Actions workflow

```yaml
# .github/workflows/npm-publish.yml

name: Publish npm packages

on:
  release:
    types: [published]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            npm-dir: darwin-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            npm-dir: darwin-x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            npm-dir: linux-x64-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            npm-dir: linux-x64-musl
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            npm-dir: linux-arm64-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            npm-dir: win32-x64-msvc

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      
      - name: Build napi bindings
        run: |
          npm install -g @napi-rs/cli
          napi build --platform --release --target ${{ matrix.target }}
        working-directory: packages/uira
      
      - name: Build CLI binary
        run: cargo build --release --target ${{ matrix.target }} -p uira
      
      - name: Copy binary to npm package
        run: |
          mkdir -p packages/uira/npm/${{ matrix.npm-dir }}
          cp target/${{ matrix.target }}/release/uira${{ matrix.os == 'windows-latest' && '.exe' || '' }} packages/uira/npm/${{ matrix.npm-dir }}/
      
      - uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: |
            packages/uira/*.node
            packages/uira/npm/${{ matrix.npm-dir }}/

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Move artifacts
        run: |
          for dir in artifacts/bindings-*/; do
            cp -r "$dir"/* packages/uira/
          done
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
      
      - name: Build TypeScript
        run: npm run build:ts
        working-directory: packages/uira
      
      - name: Publish platform packages
        run: napi prepublish -t npm && npm publish --access public
        working-directory: packages/uira
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @uiradev/hook
        run: npm publish --access public
        working-directory: packages/hook
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## Checklist

### Phase 1: Package Scaffolding
- [ ] Create `packages/` directory structure
- [ ] Create `packages/uira/package.json` with exports + `./package.json` export
- [ ] Create `packages/hook/package.json` with `dependencies` (not peer)
- [ ] Set up TypeScript config (tsup)
- [ ] Set up build scripts

### Phase 2: napi-rs Bindings
- [ ] Refactor `crates/uira-napi/src/lib.rs` (remove cli module)
- [ ] Implement `comments` module bindings
- [ ] Implement `hooks` module bindings
- [ ] Implement `oxc` module bindings
- [ ] Implement `agent` module bindings with `Arc<Mutex<_>>` for async safety
- [ ] Test bindings locally

### Phase 3: TypeScript Wrappers
- [ ] Create type definitions
- [ ] Create wrapper classes with nice API
- [ ] Write documentation
- [ ] Add examples

### Phase 4: CLI Binary Distribution
- [ ] Create `bin/uira.js` (platform binary executor)
- [ ] Create `bin/uira-hook.js`
- [ ] Test CLI locally on multiple platforms

### Phase 5: Build & Publish
- [ ] Set up GitHub Actions for multi-platform builds
- [ ] Include Linux ARM64 target
- [ ] Configure npm authentication
- [ ] Test publish to npm (dry-run)
- [ ] Publish v0.1.0

## Usage Examples

### CLI Usage

```bash
# Install globally
npm install -g @uiradev/uira

# Run AI agent
uira exec "Fix the TypeScript errors"

# Check typos with AI
uira typos --ai

# Run diagnostics
uira diagnostics --ai
```

### Library Usage

```typescript
// Comment checker
import { CommentChecker } from '@uiradev/uira/comments';

const checker = new CommentChecker();
const comments = checker.detect(code, 'file.ts');

// Linter
import { Linter } from '@uiradev/uira/oxc';

const linter = new Linter();
const diagnostics = linter.lintFiles(['src/**/*.ts']);

// AI Agent
import { Agent } from '@uiradev/uira/agent';

const agent = new Agent({ model: 'claude-sonnet-4' });
const result = await agent.run('Explain this code');
```

### Hooks Integration

```bash
# Install hooks package
npm install -D @uiradev/hook

# package.json
{
  "scripts": {
    "prepare": "uira-hook install"
  }
}
```

## Troubleshooting

### optionalDependencies Issues

If you encounter issues with optionalDependencies not installing correctly:

```bash
# Force install specific platform package
npm install @uiradev/uira-linux-x64-gnu

# Or use pnpm (recommended - better optional deps handling)
pnpm install @uiradev/uira
```

### Clean Install

```bash
rm -rf node_modules package-lock.json
npm install
```

### Platform Not Supported

If your platform is not supported, please open an issue. Current supported platforms:
- macOS: arm64 (Apple Silicon), x64 (Intel)
- Linux: x64 (glibc), x64 (musl/Alpine), arm64
- Windows: x64

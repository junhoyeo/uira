# Plan v4.0 - CRITICAL SCOPE CORRECTIONS

## Date: 2025-01-24 18:00

---

## TL;DR

**v3.0 was WRONG. Scope was 37% underestimated.**

**v4.0 NOW MATCHES actual oh-my-claudecode structure:**
- ✅ ALL 24 hook modules (was 9)
- ✅ ALL 10 feature modules (was 0)
- ✅ Hybrid agent approach (keep .md prompts)
- ✅ Proper naming (boulder → astrape)

**Timeline: 12-15 months | Effort: 1,607 hours**

---

## What Was Wrong in v3.0

### 1. Hook Modules: MASSIVELY UNDERESTIMATED

| v3.0 Plan | Reality | Gap |
|-----------|---------|-----|
| 9 hooks, 176 hours | **24 modules, 95 files, 488 hours** | **+312 hours!** |

**Missed 15 hooks:**
- autopilot (13 files!)
- learner (12 files!)
- ultrapilot, ultrawork, ultraqa
- persistent-mode, notepad
- agent-usage-reminder (4 files)
- thinking-block-validator, recovery (7 files!)
- directory-readme-injector, empty-message-sanitizer
- preemptive-compaction, plugin-patterns
- background-notification, non-interactive-env

### 2. Features Layer: COMPLETELY MISSING

| v3.0 Plan | Reality | Gap |
|-----------|---------|-----|
| 0 modules, 0 hours | **10 modules, 44 files, 264 hours** | **+264 hours!** |

**Missing modules:**
- boulder-state (plan state) → astrape-state
- notepad-wisdom (learning extraction)
- model-routing (complexity-based routing) - NEW in v2.0!
- state-manager, task-decomposer
- delegation-categories, builtin-skills
- context-injector, verification
- background-agent

### 3. Agent Approach: OVERENGINEERED

| v3.0 Plan | Reality | v4.0 Approach |
|-----------|---------|---------------|
| Port 32 agents, 280 hours | 35 .md prompts (just text) | **Keep as .md, 138 hours** |

**Smart Decision:** Agents are JUST PROMPTS. No logic to port.
- ✅ Port infrastructure (registry, config, tier builder)
- ✅ Keep .md files (embed with include_str!)
- ❌ Don't port individual agents (they're just text!)
- **Savings: 190 hours**

---

## v4.0 Corrections

### Phase 2: ALL 24 Hook Modules

**Tier 1 (Critical - 8 hooks):**
- keyword-detector, todo-continuation, ralph (5 files)
- comment-checker (4 files), think-mode (4 files)
- auto-slash-command (5 files), rules-injector (7 files)

**Tier 2 (Execution - 5 hooks):**
- autopilot (13 files!), ultrapilot (3 files)
- ultrawork, ultraqa, omc-orchestrator (3 files)

**Tier 3 (Intelligence - 3 hooks):**
- learner (12 files!), agent-usage-reminder (4 files), notepad

**Tier 4 (Validation - 3 hooks):**
- thinking-block-validator (3 files), recovery (7 files)
- empty-message-sanitizer (3 files)

**Tier 5 (Context - 3 hooks):**
- directory-readme-injector (4 files)
- non-interactive-env (4 files), persistent-mode

**Tier 6 (Optimization - 2 hooks):**
- preemptive-compaction (3 files)
- background-notification (2 files), plugin-patterns

**Total: 488 hours (was 176)**

### Phase 2.5: Features Layer (NEW)

**10 modules:**
1. astrape-state (was boulder-state) - 32 hours
2. notepad-wisdom - 24 hours
3. model-routing (v2.0 feature) - 40 hours
4. state-manager - 16 hours
5. background-agent - 32 hours
6. task-decomposer - 16 hours
7. delegation-categories - 24 hours
8. builtin-skills - 24 hours
9. context-injector - 32 hours
10. verification - 24 hours

**Total: 264 hours (was 0)**

### Phase 3: Agent Infrastructure (Hybrid)

**Port to Rust (138 hours):**
- Agent type system - 16 hours
- Registry & factory - 24 hours
- Prompt loader (include_str!) - 24 hours
- Tier builder (-low/-high) - 32 hours
- Tool restrictions - 16 hours
- getAgentDefinitions() - 24 hours
- Copy 35 .md files - 2 hours

**Keep as .md (NO porting):**
- All 35 agent prompts stay as markdown
- Loaded at compile time with include_str!
- No individual agent Rust code needed

**Total: 138 hours (was 280, saved 142 hours)**

---

## Updated Summary Table

| Phase | v3.0 | v4.0 | Change |
|-------|------|------|--------|
| 0 - Prototypes | 183h | 183h | 0 |
| 1 - Comment Checker | 64h | 64h | 0 |
| **2 - Hooks** | **176h** | **488h** | **+312h** |
| **2.5 - Features** | **0h** | **264h** | **+264h** |
| **3 - Agents** | **280h** | **138h** | **-142h** |
| 4 - Tools | 200h | 200h | 0 |
| 5 - Background/MCP | 120h | 120h | 0 |
| 6 - Integration | 150h | 150h | 0 |
| **TOTAL** | **1,173h** | **1,607h** | **+434h (+37%)** |

**Timeline:**
- v3.0: 9-12 months (31 weeks)
- v4.0: **12-15 months (40 weeks)**

---

## Hybrid Agent Approach (Smart!)

### The Realization

**Agent .md files are JUST PROMPTS:**
```markdown
---
name: architect
model: opus
tools: [Read, Glob, Grep]
---

You are an architecture advisor...
```

**No logic. No code. Just text.**

### The Solution

**Keep as markdown, load with include_str!:**

```rust
// agents/architect.md exists as markdown file
const ARCHITECT_PROMPT: &str = include_str!("../../agents/architect.md");

pub fn get_architect_agent() -> AgentConfig {
  AgentConfig {
    name: "architect",
    prompt: ARCHITECT_PROMPT,
    model: ModelType::Opus,
    tools: vec!["Read", "Glob", "Grep"],
  }
}
```

### The Savings

- v3.0: Port 32 agents individually = 280 hours
- v4.0: Port infrastructure + copy .md = 138 hours
- **Saved: 142 hours (51% reduction)**

---

## Naming Convention Updates

**Everywhere in oh-my-claudecode:**
- `boulder-state` → **`astrape-state`**
- `sisyphus` → **`astrape`**
- `omcSystemPrompt` → **`astrapeSystemPrompt`**
- `createSisyphusSession` → **`createAstrapeSession`**

**Why:**
- boulder/sisyphus are oh-my-claudecode branding
- Astrape has its own identity
- All internal references updated

---

## Files Modified

**Plan Updated:**
- `full-port-plan.md`: 971 lines → **1,100+ lines** (+150 lines)
- Version: 3.0 → **4.0**
- Scope: Accurate to oh-my-claudecode reality

**New Sections:**
- Phase 2: ALL 24 hook modules (detailed breakdown)
- Phase 2.5: Features layer (NEW, 10 modules)
- Phase 3: Hybrid agent approach (keep .md)
- Updated crate architecture diagram
- v4.0 changes summary

---

## Validation Against oh-my-claudecode

### Hooks ✅

| oh-my-claudecode | v4.0 Plan |
|------------------|-----------|
| 24 modules | ✅ 24 modules |
| 95 TypeScript files | ✅ All ported |
| autopilot (13 files) | ✅ Included |
| learner (12 files) | ✅ Included |

### Features ✅

| oh-my-claudecode | v4.0 Plan |
|------------------|-----------|
| 10 modules | ✅ 10 modules |
| 44 TypeScript files | ✅ All ported |
| boulder-state | ✅ astrape-state |
| model-routing (v2.0) | ✅ Included |

### Agents ✅

| oh-my-claudecode | v4.0 Plan |
|------------------|-----------|
| 35 .md prompts | ✅ Copy all .md |
| Dynamic loading | ✅ include_str! |
| Tier variants | ✅ Tier builder |
| No agent logic | ✅ Recognized! |

---

## Critical Takeaways

1. **v3.0 UNDERESTIMATED by 37%** - scope mismatch
2. **v4.0 NOW ACCURATE** - matches oh-my-claudecode structure
3. **Hybrid approach is SMART** - saves 142 hours on agents
4. **Timeline REALISTIC** - 12-15 months (was 9-12)
5. **ALL components included** - hooks, features, agents

---

## Next Steps

1. ✅ Plan validated against oh-my-claudecode
2. ✅ Scope corrected (24 hooks, 10 features)
3. ✅ Hybrid approach defined (agents as .md)
4. ✅ Timeline updated (12-15 months)
5. **BEGIN PHASE 0.1** - SDK integration (2 weeks)

---

**PLAN IS NOW ACCURATE. READY FOR EXECUTION.**

**v4.0 > v3.0 > v2.0**

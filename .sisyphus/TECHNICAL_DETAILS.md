# Claude Agent SDK - Technical Deep Dive

## 1. SDK Architecture

### 1.1 Module Structure

```
@anthropic-ai/claude-agent-sdk (v0.2.19)
├── entrypoints/
│   ├── sdk/
│   │   ├── runtimeTypes.d.ts      # Runtime configuration types
│   │   ├── coreTypes.d.ts         # Core message/response types
│   │   └── index.ts               # Main SDK exports
│   └── cli.js                     # CLI wrapper (minified)
├── package.json                   # ESM-only, Node 18+
└── [compiled JavaScript]
```

### 1.2 Main Export: `query()` Function

```typescript
// From @anthropic-ai/claude-agent-sdk
export async function* query(options: QueryOptions): AsyncGenerator<Message>

interface QueryOptions {
  prompt: string;
  options?: {
    systemPrompt?: string;
    agents?: Record<string, AgentDefinition>;
    mcpServers?: Record<string, McpServerConfig>;
    allowedTools?: string[];
    permissionMode?: 'acceptEdits' | 'bypassPermissions' | 'default';
    // ... other options
  };
}

interface Message {
  type: 'text' | 'tool_use' | 'tool_result' | 'error';
  content?: string;
  // ... message-specific fields
}
```

### 1.3 Runtime Initialization

When `query()` is called:

1. **Validate Options** - Check systemPrompt, agents, tools, etc.
2. **Spawn Claude Code CLI** - If not already running
3. **Establish IPC** - Connect to CLI subprocess
4. **Send Prompt** - Serialize and send to CLI
5. **Stream Responses** - Yield messages as they arrive
6. **Handle Errors** - Propagate CLI errors to caller

### 1.4 Claude Code CLI Interaction

```
SDK (Node.js)
  ↓ (spawn subprocess)
Claude Code CLI
  ↓ (stdio)
  ├─ stdin: JSON commands
  ├─ stdout: JSON responses
  └─ stderr: logs
```

**CLI Responsibilities:**
- Tool execution (Bash, Edit, Read, WebSearch, etc.)
- Permission management
- Sandbox isolation
- Session state

---

## 2. Session Model

### 2.1 SDK Session Semantics

**The SDK has NO persistent session concept.**

Each `query()` call is **stateless and independent**:

```typescript
// Call 1
for await (const msg of query({ prompt: "Hello" })) { }

// Call 2 (completely independent from Call 1)
for await (const msg of query({ prompt: "World" })) { }
```

**Implications:**
- No session ID returned by SDK
- No session state persisted between calls
- Each call starts fresh with provided options
- Context must be passed in system prompt or agents

### 2.2 Astrape's Session Abstraction

Astrape adds a session layer on top:

```rust
pub struct AstrapeSession {
    pub query_options: QueryOptions,  // Pre-configured options
    pub state: SessionState,          // Astrape-managed state
    pub config: PluginConfig,         // Loaded configuration
}

pub struct SessionState {
    pub session_id: Option<String>,           // Generated UUID
    pub active_agents: HashMap<String, AgentState>,
    pub background_tasks: Vec<BackgroundTask>,
    pub context_files: Vec<String>,
}
```

**How it works:**
1. `AstrapeSession::new()` prepares options (system prompt, agents, tools)
2. Each `query()` call uses these pre-configured options
3. Astrape tracks state (agents, tasks, context) separately
4. Session ID is generated by Astrape, not SDK

### 2.3 State Persistence

**SDK:** No persistence (stateless)
**Astrape:** Can persist session state to disk (not implemented yet)

```rust
// TODO: Implement session persistence
pub fn save_session(&self, path: &str) -> SdkResult<()> {
    // Serialize session_state to JSON
    // Write to disk
}

pub fn load_session(path: &str) -> SdkResult<AstrapeSession> {
    // Read from disk
    // Deserialize JSON
}
```

---

## 3. Protocol Details

### 3.1 Bridge Protocol (JSON-RPC 2.0 style)

**Request Format:**
```json
{
  "id": "1",
  "method": "query",
  "params": {
    "prompt": "Fix the bug in src/main.rs",
    "options": {
      "systemPrompt": "You are a helpful assistant...",
      "agents": {
        "researcher": {
          "description": "Searches and analyzes code",
          "prompt": "You are a code researcher...",
          "tools": ["Read", "Glob", "Grep"],
          "model": "claude-3-5-sonnet-20241022"
        }
      },
      "mcpServers": {
        "filesystem": {
          "command": "node",
          "args": ["mcp-server-filesystem.js"],
          "env": { "DEBUG": "true" }
        }
      },
      "allowedTools": ["Read", "Edit", "Bash", "WebSearch"],
      "permissionMode": "acceptEdits"
    }
  }
}
```

**Response Format (Streaming):**
```json
{ "id": "1", "stream": true, "data": { "type": "text", "content": "I'll analyze..." } }
{ "id": "1", "stream": true, "data": { "type": "tool_use", "tool": "Read", "path": "src/main.rs" } }
{ "id": "1", "stream": true, "data": { "type": "tool_result", "result": "fn main() { ... }" } }
{ "id": "1", "stream": true, "data": { "type": "text", "content": "I found the bug..." } }
{ "id": "1", "result": { "done": true } }
```

**Error Response:**
```json
{ "id": "1", "error": { "code": -32000, "message": "Claude Code CLI not found" } }
```

### 3.2 Bridge Implementation (Rust)

```rust
// crates/astrape-sdk/src/bridge.rs

pub struct SdkBridge {
    process: Child,           // Node.js process
    stdin: ChildStdin,        // Write requests
    stdout: BufReader<ChildStdout>,  // Read responses
}

impl SdkBridge {
    pub fn new() -> SdkResult<Self> {
        // Spawn: node bridge/dist/index.js
        // Connect stdin/stdout
    }

    pub fn query(&mut self, params: QueryParams) -> SdkResult<mpsc::Receiver<SdkResult<StreamMessage>>> {
        // Send request to bridge
        // Spawn task to read responses
        // Return channel for streaming messages
    }
}
```

### 3.3 Bridge Implementation (TypeScript)

```typescript
// bridge/src/index.ts

async function handleQuery(id: string, params: QueryParams): Promise<void> {
  try {
    const queryOptions = {
      prompt: params.prompt,
      options: params.options || {},
    };

    // Call SDK's query() function
    for await (const message of query(queryOptions)) {
      // Stream each message back to Rust
      sendResponse({
        id,
        stream: true,
        data: message,
      });
    }

    // Signal completion
    sendResponse({ id, result: { done: true } });
  } catch (error) {
    sendError(id, -32000, error.message);
  }
}
```

---

## 4. Runtime Requirements

### 4.1 Node.js Version Matrix

| SDK Version | Min Node.js | Tested | Notes |
|-------------|------------|--------|-------|
| 0.2.19 | 18+ | 20+ | Current (Astrape) |
| 0.1.x | 18+ | 18+ | Older version |

**Why Node.js 18+?**
- ESM support (import/export)
- Async generators (for await...of)
- Modern crypto APIs
- Subprocess management

### 4.2 Claude Code CLI Version

**Required:** Latest version (auto-installed via `npm install -g @anthropic-ai/claude-code`)

**Compatibility:** SDK version should match CLI version
- SDK 0.2.19 → CLI 0.2.x
- SDK 0.1.x → CLI 0.1.x

**Version Mismatch Behavior:**
- ⚠️ May cause protocol errors
- ⚠️ Tool availability may differ
- ⚠️ Error messages may be unclear

### 4.3 Environment Variables

| Variable | Required | Set By | Used For |
|----------|----------|--------|----------|
| `ANTHROPIC_API_KEY` | ✅ Yes | User/CI | API authentication |
| `NODE_PATH` | ❌ No | Node.js | Module resolution (rarely needed) |
| `DEBUG` | ❌ No | User | Enable debug logging |
| `CLAUDE_CODE_CLI` | ❌ No | SDK | Path to CLI (auto-detected) |

**Auto-Detection Logic:**
```typescript
// SDK auto-detects Claude Code CLI location
const cliPath = process.env.CLAUDE_CODE_CLI || 
                findInPATH('claude-code') ||
                findInNpmGlobal('@anthropic-ai/claude-code');
```

### 4.4 System Requirements

| Resource | Minimum | Recommended |
|----------|---------|-------------|
| RAM | 512MB | 2GB |
| Disk | 100MB | 1GB |
| CPU | 1 core | 2+ cores |
| Network | HTTPS | HTTPS + WebSearch |

---

## 5. Error Handling

### 5.1 Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `Claude Code CLI not found` | CLI not installed | `npm install -g @anthropic-ai/claude-code` |
| `ANTHROPIC_API_KEY not set` | Missing API key | Set environment variable |
| `Tool not available` | Tool not in allowedTools | Add to allowedTools array |
| `Permission denied` | permissionMode too restrictive | Change to 'acceptEdits' or 'bypassPermissions' |
| `Timeout` | CLI unresponsive | Increase timeout, check system resources |

### 5.2 Error Propagation

```
Claude Code CLI
  ↓ (error)
SDK (Node.js)
  ↓ (throw Error)
Bridge (JSON-RPC)
  ↓ (send error response)
Rust (astrape-sdk)
  ↓ (convert to SdkError)
Astrape CLI
  ↓ (display to user)
```

### 5.3 Retry Logic

**Current:** No automatic retries
**Recommended:** Implement for transient failures

```rust
pub async fn query_with_retry(
    bridge: &mut SdkBridge,
    params: QueryParams,
    max_retries: u32,
) -> SdkResult<mpsc::Receiver<SdkResult<StreamMessage>>> {
    for attempt in 0..max_retries {
        match bridge.query(params.clone()) {
            Ok(rx) => return Ok(rx),
            Err(e) if is_transient(&e) && attempt < max_retries - 1 => {
                tokio::time::sleep(Duration::from_millis(100 * 2_u64.pow(attempt))).await;
                continue;
            }
            Err(e) => return Err(e),
        }
    }
}
```

---

## 6. Performance Characteristics

### 6.1 Startup Latency

```
Rust → spawn Node.js → import SDK → spawn CLI
  ↓         ↓           ↓           ↓
  0ms      200ms       300ms       500ms
```

**Total:** ~500ms-1s per query

**Breakdown:**
- Node.js startup: ~200ms
- SDK import: ~100ms
- CLI spawn: ~200ms
- Total: ~500ms

### 6.2 Memory Usage

| Component | Memory | Notes |
|-----------|--------|-------|
| Node.js process | 30-50MB | Base runtime |
| SDK loaded | 10-20MB | Compiled code |
| CLI subprocess | 20-50MB | Sandbox |
| **Total** | **60-120MB** | Per bridge process |

### 6.3 Message Throughput

| Metric | Value | Notes |
|--------|-------|-------|
| Startup | 500ms-1s | Per query |
| First message | 1-2s | Time to first response |
| Streaming | 10-100ms | Per message |
| Serialization | <1ms | JSON encoding |

### 6.4 Optimization Opportunities

1. **Persistent Bridge Process** (500ms → <10ms)
   - Keep Node.js process alive
   - Reuse for multiple queries
   - Requires connection pooling

2. **Process Pooling** (1 process → N processes)
   - Maintain pool of bridge processes
   - Distribute queries across pool
   - Requires load balancing

3. **Lazy CLI Spawn** (500ms → 200ms)
   - Don't spawn CLI until first tool use
   - Requires protocol changes

---

## 7. Compatibility Matrix

### 7.1 Node.js Versions

| Version | Status | Notes |
|---------|--------|-------|
| 18.x | ✅ Supported | Minimum version |
| 20.x | ✅ Supported | Recommended (Astrape) |
| 22.x | ✅ Supported | Latest LTS |
| 16.x | ❌ Not supported | Too old |

### 7.2 Operating Systems

| OS | Status | Notes |
|----|--------|-------|
| macOS (Intel) | ✅ Supported | Primary development |
| macOS (ARM) | ✅ Supported | M1/M2/M3 |
| Linux (x86) | ✅ Supported | Ubuntu, Debian, etc. |
| Linux (ARM) | ✅ Supported | Raspberry Pi, etc. |
| Windows | ✅ Supported | WSL2 recommended |

### 7.3 SDK Versions

| Version | Status | Notes |
|---------|--------|-------|
| 0.2.19 | ✅ Current | Latest |
| 0.2.x | ✅ Supported | Patch updates |
| 0.1.x | ⚠️ Deprecated | Old API |
| 0.0.x | ❌ Unsupported | Pre-release |

---

## 8. Integration Patterns

### 8.1 Single Query Pattern

```rust
let mut bridge = SdkBridge::new()?;
let rx = bridge.query(QueryParams {
    prompt: "Fix the bug".to_string(),
    options: Some(options),
})?;

while let Some(msg) = rx.recv().await {
    match msg {
        Ok(msg) => println!("{:?}", msg),
        Err(e) => eprintln!("Error: {}", e),
    }
}
```

### 8.2 Persistent Bridge Pattern

```rust
let mut bridge = SdkBridge::new()?;

// Query 1
let rx1 = bridge.query(params1)?;
// ... handle responses

// Query 2 (reuses same bridge)
let rx2 = bridge.query(params2)?;
// ... handle responses
```

### 8.3 Process Pool Pattern

```rust
let pool = BridgePool::new(4)?;  // 4 processes

let rx1 = pool.query(params1)?;
let rx2 = pool.query(params2)?;
let rx3 = pool.query(params3)?;

// Queries run in parallel across pool
```

---

## 9. Debugging

### 9.1 Enable Debug Logging

```bash
DEBUG=* astrape query "Your prompt"
```

### 9.2 Inspect Bridge Protocol

```bash
# Capture JSON-RPC messages
strace -e write astrape query "Your prompt" 2>&1 | grep -A5 "write(3"
```

### 9.3 Check CLI Status

```bash
# Verify CLI is installed
which claude-code

# Check version
claude-code --version

# Test CLI directly
echo '{"prompt":"test"}' | node bridge/dist/index.js
```

---

## 10. Migration Path

### 10.1 From Old SDK (@anthropic-ai/claude-code)

**Changes:**
- Package name: `@anthropic-ai/claude-code` → `@anthropic-ai/claude-agent-sdk`
- Type name: `ClaudeCodeOptions` → `ClaudeAgentOptions`
- System prompt: No longer loaded from filesystem

**Migration:**
```typescript
// Old
import { query } from '@anthropic-ai/claude-code';

// New
import { query } from '@anthropic-ai/claude-agent-sdk';
```

### 10.2 To Future Versions

**Monitoring:**
- Watch for breaking changes in SDK releases
- Test against new versions before upgrading
- Maintain version pinning in package.json

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-24  
**Status:** Complete
